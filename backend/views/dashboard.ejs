<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - FinTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3B82F6",
              secondary: "#1E40AF",
              accent: "#10B981",
              success: "#10B981",
              warning: "#F59E0B",
              danger: "#EF4444",
            },
          },
        },
      };
    </script>
    <style>
      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>

  <body class="bg-gradient-to-b from-gray-900 to-gray-500 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-gradient-to-b from-black to-transparent sticky top-0 z-30">
      <div class="max-w-8xl mx-auto px-4">
        <div class="flex justify-between items-center py-4 px-4">
          <!-- Logo -->
          <a href="/dashboard" class="flex items-center group">
            <div
              class="inline-flex items-center justify-center w-10 h-10 bg-primary rounded-full mr-3 transition-transform group-hover:scale-105"
            >
              <i class="fas fa-wallet text-white"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-400 hidden sm:block group-hover:text-primary transition-colors">FinTrack</h1>
          </a>

          <!-- Navigation Links -->
          <div class="flex items-center justify-between space-x-2 flex-wrap">
            <a
              href="/dashboard"
              class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition duration-200 flex items-center justify-center"
              title="Dashboard"
            >
              <i class="fas fa-home"></i>
            </a>
            <a
              href="/transactions"
              class="text-gray-300 hover:text-primary transition duration-200 px-4 py-2 bg-black bg-opacity-40 backdrop-blur-md rounded-lg flex items-center justify-center"
              title="Transactions"
            >
              <i class="fas fa-exchange-alt"></i>
            </a>
            <a
              href="/budgets"
              class="text-gray-300 hover:text-primary transition duration-200 px-4 py-2 bg-black bg-opacity-40 backdrop-blur-md rounded-lg flex items-center justify-center"
              title="Budgets"
            >
              <i class="fas fa-chart-pie"></i>
            </a>
            <a
              href="/categories"
              class="text-gray-300 hover:text-primary transition duration-200 px-4 py-2 bg-black bg-opacity-40 backdrop-blur-md rounded-lg flex items-center justify-center"
              title="Categories"
            >
              <i class="fas fa-tags"></i>
            </a>
            <a
              href="/saving-goals"
              class="text-gray-300 hover:text-primary transition duration-200 px-4 py-2 bg-black bg-opacity-40 backdrop-blur-md rounded-lg flex items-center justify-center"
              title="Saving Goals"
            >
              <i class="fas fa-piggy-bank"></i>
            </a>
            <a
              href="/notifications"
              class="text-gray-300 hover:text-primary transition duration-200 px-4 py-2 bg-black bg-opacity-40 backdrop-blur-md rounded-lg flex items-center justify-center"
              title="Notifications"
            >
              <i class="fas fa-bell"></i>
            </a>
            <a
              href="/export"
              class="text-gray-300 hover:text-primary transition duration-200 px-4 py-2 bg-black bg-opacity-40 backdrop-blur-md rounded-lg flex items-center justify-center"
              title="Export"
            >
              <i class="fas fa-download"></i>
            </a>
            <a
              href="/profile"
              class="text-gray-300 hover:text-primary transition duration-200 px-4 py-2 bg-black bg-opacity-40 backdrop-blur-md rounded-lg flex items-center justify-center"
              title="Profile"
            >
              <i class="fas fa-user"></i>
            </a>
            <a
              href="/auth/logout"
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center"
              title="Logout"
            >
              <i class="fas fa-sign-out-alt"></i>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
      <!-- Success/Error Messages -->
      <% if (typeof success !=='undefined' && success) { %>
      <div class="max-w-4xl mx-auto mb-6">
        <div
          class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg"
        >
          <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <%= success %>
          </div>
        </div>
      </div>
      <% } %>

      <% if (typeof error !=='undefined' && error) { %>
      <div class="max-w-4xl mx-auto mb-6">
        <div
          class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg"
        >
          <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <%= error %>
          </div>
        </div>
      </div>
      <% } %>

      <!-- Balance Card - Top Priority -->
      <div class="mx-auto">
        <div class="relative rounded-xl p-8 text-white overflow-hidden">
          <div class="absolute inset-0 z-0">
            <img
              src="/img/balance_bg.png"
              alt="Balance Background"
              class="w-full h-full object-cover opacity-50 blur-sm"
            />
          </div>
          <div
            class="absolute inset-0 bg-gradient-to-r from-blue-700 to-transparent z-10"
          ></div>
          <div class="relative z-20">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-2xl font-semibold mb-2">Current Balance</h2>
                <p class="text-blue-100 mb-4">
                  Hello <%= user.firstName %>! Here's your financial overview
                </p>
                <div class="text-4xl font-bold">
                  <%= user.currency %> <%= user.balance %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats Cards -->
    <%- include('partials/quickStats') %>

    <!-- Quick Actions -->
    <%- include('partials/quickActions') %>

    <!-- Improved Grid Layout -->
    <div class=" mx-auto px-4">
      <!-- Top Row - Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <%- include('partials/spendingChart') %> <%-
        include('partials/incomeAnalytics') %>
      </div>

      <!-- Middle Row - Income, Expenses and Transactions -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <%- include('partials/otherIncome') %> <%- include('partials/expenseDetails') %> <%-
        include('partials/recentTransactions') %>
      </div>

      <!-- Bottom Row - Budget and Goals -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <%- include('partials/budgetOverview') %> <%-
        include('partials/savingGoals') %>
      </div>
    </div>


    <script>

      // Initialize Charts
      document.addEventListener("DOMContentLoaded", function () {
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
      
        const spendingData = {
          labels: <%- JSON.stringify(spendingChartData.labels) %> || [],
          data: <%- JSON.stringify(spendingChartData.data) %> || [],
          backgroundColor: <%- JSON.stringify(spendingChartData.backgroundColor) %> || [],
        };

        // Show message if no spending data
        if (spendingData.labels.length === 0) {
          spendingData.labels = ['No Data'];
          spendingData.data = [1];
          spendingData.backgroundColor = ['#E5E7EB'];
        }

        // Doughnut Chart
        const spendingCtx = document
          .getElementById("spendingChart")
          .getContext("2d");
        new Chart(spendingCtx, {
          type: "doughnut",
          data: {
            labels: spendingData.labels,
            datasets: [
              {
                data: spendingData.data,
                backgroundColor: spendingData.backgroundColor,
                borderWidth: 0,
                hoverOffset: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  font: { size: 12 },
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.parsed;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0,
                    );
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: $${value} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
        // Bar Chart 
        const incomeSourcesData = {
          labels: <%- JSON.stringify(incomeChartData.labels) %> || [],
          currentBalance: <%- JSON.stringify(incomeChartData.data) %> || [],
          backgroundColor: <%- JSON.stringify(incomeChartData.backgroundColor) %> || [],
          borderColor: <%- JSON.stringify(incomeChartData.borderColor) %> || [],
        };

        // Show message if no income data
        if (incomeSourcesData.labels.length === 0) {
          incomeSourcesData.labels = ['No Data'];
          incomeSourcesData.currentBalance = [1];
          incomeSourcesData.backgroundColor = ['#E5E7EB'];
          incomeSourcesData.borderColor = ['#9CA3AF'];
        }

        const incomeCtx = document
          .getElementById("incomeAnalyticsChart")
          .getContext("2d");
        new Chart(incomeCtx, {
          type: "bar",
          data: {
            labels: incomeSourcesData.labels,
            datasets: [
              {
                label: "Income Amount",
                data: incomeSourcesData.currentBalance,
                backgroundColor: incomeSourcesData.backgroundColor,
                borderColor: incomeSourcesData.borderColor,
                borderWidth: 1,
                borderRadius: 4,
                borderSkipped: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `Income: $${context.parsed.y.toLocaleString()}`;
                  },
                },
              },
              datalabels: {
                display: true,
                color: "#374151",
                font: {
                  size: 12,
                  weight: "bold",
                },
                formatter: function (value) {
                  return "$" + value.toLocaleString();
                },
                anchor: "end",
                align: "top",
                offset: 4,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Income Amount ($)",
                  font: {
                    size: 12,
                    weight: "bold",
                  },
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                  drawBorder: false,
                },
                ticks: {
                  callback: function (value) {
                    return "$" + value.toLocaleString();
                  },
                  font: {
                    size: 11,
                  },
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Income Sources",
                  font: {
                    size: 12,
                    weight: "bold",
                  },
                },
                grid: {
                  display: false,
                },
                ticks: {
                  font: {
                    size: 11,
                  },
                  maxRotation: 45,
                  minRotation: 0,
                },
              },
            },
          },
        });
      });

      document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress-bar[data-width]');
        progressBars.forEach(bar => {
          const width = bar.getAttribute('data-width');
          bar.style.width = width;
        });
      });

      function openTransactionModal(type = '') {
        if (type) {
          window.location.href = `/transactions?modal=${type}`;
        } else {
          window.location.href = '/transactions';
        }
      }
    </script>
  </body>
</html>
